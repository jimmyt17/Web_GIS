<!DOCTYPE html>
<html>
<head>
  <title>Leaflet Timeline Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/leaflet.timeline@1.5.1/dist/leaflet.timeline.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-timeline-slider/dist/leaflet-timeline-slider.min.js"></script>

  <style>
    html, body { margin:0; padding:0; }
    #info {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 25vw;
      padding: 1em;
      overflow-y: auto;
    }
    #map {
      position: fixed;
      top: 0;
      left: 25vw;
      bottom: 0;
      right: 0;
    }
  </style>
</head>

<body>

<div id="info">
  <p>Latest poll from:</p>
  <ul id="displayed-list"></ul>
</div>

<div id="map"></div>

<script>

function getColorFor(value) {
  return value >= 1 ? '#2166ac' :
         value >= 0 ? '#ffffbf' :
                      '#b2182b';
}

var minValue = 1;
var minRadius = 4;

function calcRadius(val) {
  return 1.0083 * Math.pow(val/minValue, .5716) * minRadius;
}

var map = L.map("map").setView([38, -95], 4);

L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
).addTo(map);

function updateList(timeline) {
  var displayed = timeline.getLayers();
  var list = document.getElementById("displayed-list");
  list.innerHTML = "";
  displayed.forEach(function(layer) {
    var props = layer.feature.properties;
    var li = document.createElement("li");
    li.innerHTML = props.NAME +
      " - Biden: " + props.DEM +
      ", Trump: " + props.REP;
    list.appendChild(li);
  });
}

fetch("Statepolls_Centroid_moved.geojson")
  .then(response => response.json())
  .then(data => {

    var timeline = L.timeline(data, {
      getInterval: function(feature) {
        return {
          start: feature.properties.start,
          end: feature.properties.end
        };
      },

      pointToLayer: function(feature, latlng) {
        return L.circleMarker(latlng, {
          radius: calcRadius(feature.properties.EV),
          color: getColorFor(feature.properties.DIFF),
          fillColor: getColorFor(feature.properties.DIFF),
          fillOpacity: 0.7
        }).bindPopup(
          "<p>Electoral Votes: " + feature.properties.EV + "</p>"
        );
      }
    });

    var slider = L.timelineSliderControl({
      formatOutput: function(date) {
        return new Date(date).toLocaleDateString();
      }
    });

    slider.addTo(map);
    slider.addTimelines(timeline);
    timeline.addTo(map);

    timeline.on("change", function(e) {
      updateList(e.target);
    });

    updateList(timeline);
  });

</script>

</body>
</html>
